# GEMINI.md: TypeGlobe プロジェクト

このドキュメントは、クイズ＆タイピングゲーム「TypeGlobe」の要件、仕様、設計、実装計画をまとめたものです。

## 1. プロジェクト概要

- **プロジェクト名:** TypeGlobe (仮称)
- **コンセプト:** クイズとタイピングを融合させた、多言語対応の教育的ゲーム。世界中のユーザーが楽しみながらタイピングスキルと知識を向上させることを目指す。オフラインでの動作を基本とする。

## 2. 要件

### 2.1. 機能要件
- **ゲームモード:** ユーザーは複数の異なるゲームモードをプレイできる。
  - クイズモード
  - タイピングモード
  - クイズ＋タイピングモード
  - タイムアタック25モード (アタック25風対戦)
  - RPG風経験値モード (TypeQuest)
- **ステルスモード:** 仕事中などにプレイしていることを隠すため、見た目をCLIツール風に偽装するモードを提供する。
- **クイズコンテンツ:** 多様なジャンルと形式のクイズを提供する。
  - **ジャンル:** 地理、歴史、科学、プログラミング、語彙など。ユーザーによるジャンル選択を可能にする。
  - **形式:** テキスト問題、画像問題（国旗、AI生成画など）、コードスニペット問題。
- **多言語対応:**
  - ユーザーは起動時にプレイ言語（日本語、英語など）を選択できる。
  - 問題文やUIは選択された言語で表示される。
- **入力:**
  - 漢字変換を必要としないローマ字でのタイピングを基本とする。
  - 4択クイズでは、選択肢番号のキー入力にも対応する。
- **スコアリングとランキング:**
  - スコア（正確性、速度、難易度を考慮）とランキングを記録・表示する。
  - ランキングは言語別、およびゲームモード別に管理する。
- **プレイヤーデータ:**
  - RPGモードのレベルや経験値などの進捗をローカルに保存する。
- **オフライン動作:** インターネット接続なしで、すべてのコア機能が動作する。

### 2.2. 非機能要件
- **パフォーマンス:** CUI/TUIアプリケーションとして、軽快で高速な応答性能を持つ。
- **クロスプラットフォーム:** Windows, macOS, Linuxの主要なデスクトップOSで動作する。
- **データ永続化:** ゲームデータ（問題、ランキング、プレイヤー情報）は、ユーザーのマシン上にローカルファイル（JSON形式を想定）として保存する。
- **拡張性:** 将来的に新しいクイズ、言語、ゲームモードを追加しやすい、モジュール化された設計とする。

## 3. 仕様

### 3.1. ゲームモード詳細
- **クイズモード:** 4択問題に対し、対応するキー（例: `1`-`4` or `a`-`d`）で回答する。
- **タイピングモード:** 表示される単語や文章をタイピングし、WPM（Words Per Minute）と正確性を計測する。
- **クイズ＋タイピングモード:** 4択問題の正解の選択肢を、全文ローマ字でタイピングして回答する。
- **タイムアタック25:** 5x5のパネルをクイズで取り合うCPU対戦モード。思考や操作時間も含めた合計時間でクリアタイムを競う。
- **RPGモード (TypeQuest):** 正解に応じて経験値（EXP）を獲得し、レベルアップする。レベルに応じて称号などが得られる。
- **ステルスモード:** 表示を「ログ解析中」「データストリーム監視中」のような、一般的なCLIツールの出力に偽装する。

### 3.2. クイズコンテンツ
- **データソース:** 問題と選択肢は、生成AIを用いて作成し、多言語へ翻訳する。
- **画像データ:** 画像クイズで使用する画像ファイルは、アプリケーションに同梱し、ローカルパスで参照する。

### 3.3. UI/UX
- CUIまたはTUI（Text-based User Interface）をベースとする。
- 起動時に言語とゲームモードを選択するメニューを表示する。
- 操作はすべてキーボードで完結する。

## 4. 設計

### 4.1. アーキテクチャ
Rustのモジュールシステムを活用し、関心事の分離を行う。
- `main.rs`: エントリーポイント。初期設定、言語・モード選択のロジックを配置。
- `game/`: 各ゲームモードのコアロジックを格納するモジュール。
  - `quiz.rs`
  - `typing.rs`
  - `time_attack.rs`
  - `rpg.rs`
- `io/`: データI/O関連のモジュール。
  - `data_loader.rs`: クイズデータ（JSON）の読み込みとパース。
  - `storage.rs`: ランキングやプレイヤーデータの読み書き。
- `ui/`: ユーザーインターフェースの描画と入力を担当するモジュール。`ratatui`と`crossterm`を利用。
- `config.rs`: アプリケーション全体の設定を管理。

### 4.2. データ構造 (JSON)
- **問題データ (`questions_xx.json`):**
  ```json
  [
    {
      "id": "q001",
      "genre": "science",
      "question_text": {
        "ja": "水の化学式は？",
        "en": "What is the chemical formula for water?"
      },
      "choices": [
        {"ja": "CO2", "en": "CO2"},
        {"ja": "H2O", "en": "H2O"},
        {"ja": "O2", "en": "O2"},
        {"ja": "N2", "en": "N2"}
      ],
      "correct_answer_index": 1,
      "image_path": null
    }
  ]
  ```
- **プレイヤーデータ (`player.json`):**
  ```json
  {
    "player_name": "User",
    "language": "ja",
    "rpg_stats": {
      "level": 1,
      "exp": 0
    }
  }
  ```
- **ランキングデータ (`ranking_xx.json`):**
  ```json
  {
    "quiz_mode": [
      {"name": "Player1", "score": 1500}
    ],
    "time_attack": [
      {"name": "PlayerX", "time_seconds": 180}
    ]
  }
  ```

### 4.3. 技術選定
- **言語:** Rust (高速性、安全性、クロスプラットフォーム対応のため)
- **CUI/TUIライブラリ:** `ratatui` / `tui-rs` および `crossterm`
- **データシリアライズ:** `serde` (`serde_json`)

## 5. 実装の段取り (マイルストーン)

- **フェーズ1: コア機能の実装 (MVP)** ✅ **完了**
  1. ✅ `cargo`プロジェクトのセットアップ。
  2. ✅ 基本的なデータ構造の定義と、JSONからの問題読み込み機能の実装。
  3. ✅ **クイズモード**と**タイピングモード**の基本ロジックを実装。
  4. ✅ 起動時のモード選択UIを実装。

- **フェーズ2: 応用機能の追加** 🚧 **進行中**
  1. **クイズ＋タイピングモード**を実装。
  2. ローカルファイルへの**ランキング機能**（スコア保存・表示）を実装。
  3. **多言語対応**の基盤（言語選択、データ切り替え）を実装。

- **フェーズ3: 拡張モードの実装**
  1. **タイムアタック25モード**のロジックとTUIを実装。
  2. **RPGモード**の経験値システムとプレイヤーデータの永続化を実装。

- **フェーズ4: 仕上げとコンテンツ拡充**
  1. **ステルスモード**を実装。
  2. **画像クイズ**、**コードクイズ**に対応するための機能拡張。
  3. 生成AIを活用してクイズ問題を量産し、コンテンツを拡充。
  4. 全体的なリファクタリング、パフォーマンスチューニング、バグ修正。

## 6. 実装進捗状況

### 完了済み機能
- ✅ **プロジェクト基盤**: Cargo設定、依存関係（ratatui, crossterm, serde）
- ✅ **データ構造**: Question, Player, Ranking, GameMode, Language型定義
- ✅ **データI/O**: JSON読み込み・保存、サンプル問題生成
- ✅ **クイズモード**: 4択問題、スコア計算、進捗表示、結果画面
- ✅ **タイピングモード**: WPM計算、正確性測定、リアルタイム文字色分け
- ✅ **UIシステム**: メニュー選択、言語選択（日本語/英語）
- ✅ **ゲームエンジン**: QuizGame, TypingGameロジック完全実装

### 現在の実装状況
- **ファイル構成**: 
  - `src/main.rs`: エントリーポイントとゲームモード分岐
  - `src/types.rs`: 基本データ型定義
  - `src/config.rs`: 設定管理
  - `src/game/`: quiz.rs, typing.rs（ゲームロジック）
  - `src/io/`: data_loader.rs, storage.rs, typing_texts.rs
  - `src/ui/`: menu.rs, quiz.rs, typing.rs（TUIインターフェース）

### 動作確認済み機能
1. **メニューシステム**: 言語選択 → ゲームモード選択
2. **クイズモード**: 
   - 問題表示、選択肢操作（↑↓キー、1-4数字）
   - 正解・不正解判定、スコア計算
   - 進捗表示、最終結果表示
3. **タイピングモード**:
   - リアルタイム文字入力、色分け表示
   - WPM・正確性のリアルタイム計算
   - 完了時統計表示

### 次のステップ
フェーズ2の応用機能実装に向けて準備完了。特にクイズ+タイピングモードとランキング機能の実装が次の優先項目。
